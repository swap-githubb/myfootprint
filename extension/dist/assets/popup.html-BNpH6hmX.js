(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))r(t);new MutationObserver(t=>{for(const n of t)if(n.type==="childList")for(const l of n.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&r(l)}).observe(document,{childList:!0,subtree:!0});function s(t){const n={};return t.integrity&&(n.integrity=t.integrity),t.referrerPolicy&&(n.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?n.credentials="include":t.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function r(t){if(t.ep)return;t.ep=!0;const n=s(t);fetch(t.href,n)}})();const g=document.getElementById("login-view"),f=document.getElementById("summary-view"),h=document.getElementById("app-footer"),w=document.getElementById("login-form"),u=document.getElementById("login-btn"),m=document.getElementById("login-error"),a=document.getElementById("summarize-btn"),d=document.getElementById("page-info"),p=document.getElementById("status-message"),b=document.getElementById("username-display"),E=document.getElementById("logout-btn"),I="http://localhost:8000";let y=null;function c(e,o=!0){const s=e.querySelector(".spinner"),r=e.querySelector(".btn-text");o?(s.style.display="block",r&&(r.style.display="none"),e.disabled=!0):(s.style.display="none",r&&(r.style.display="block"),e.disabled=!1)}function i(e,o="info"){p.textContent=e,p.className=o}async function v(){const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e.url||!e.url.startsWith("http")){d.innerHTML="<p>Cannot summarize this page.</p>",a.disabled=!0;return}const[o]=await chrome.scripting.executeScript({target:{tabId:e.id},function:()=>{const r=!!document.querySelector('article, [role="article"]');return document.querySelector("video")?"video":r||document.body.innerText.length>2e3?"article":null}}),s=o.result;s?(d.innerHTML=`<p>Found a potential <b>${s}</b> to summarize.</p>`,a.disabled=!1,y={tab:e,contentType:s}):(d.innerHTML="<p>No article or video found on this page.</p>",a.disabled=!0)}document.addEventListener("DOMContentLoaded",async()=>{const{token:e}=await chrome.storage.local.get("token");e&&(g.style.display="none",f.style.display="block",h.style.display="flex",b.textContent="user",await v())});w.addEventListener("submit",async e=>{e.preventDefault(),c(u),m.textContent="";const o=document.getElementById("username").value,s=document.getElementById("password").value,r=new URLSearchParams({username:o,password:s});try{const t=await fetch(`${I}/token`,{method:"POST",body:r});if(!t.ok)throw new Error("Invalid username or password.");const n=await t.json();await chrome.storage.local.set({token:n.access_token}),window.location.reload()}catch(t){m.textContent=t.message,c(u,!1)}});E.addEventListener("click",async()=>{await chrome.storage.local.remove("token"),window.location.reload()});a.addEventListener("click",async()=>{c(a),i("Waking background…");try{await chrome.runtime.sendMessage({type:"ping"}),console.log("[popup] ping success")}catch{console.warn("[popup] ping error:",chrome.runtime.lastError)}i("Initializing model…"),chrome.runtime.sendMessage({type:"summarize",payload:y},e=>{console.log("[popup] summarize response:",e),chrome.runtime.lastError?i("Background unavailable. Try again.","error"):e?.success?i("Saved successfully!","success"):i(e?.error||"Unknown error","error"),c(a,!1),a.disabled=!0})});chrome.runtime.onMessage.addListener(e=>{e.type==="progress"&&i(e.data)});
