(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const d of s.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&r(d)}).observe(document,{childList:!0,subtree:!0});function o(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(n){if(n.ep)return;n.ep=!0;const s=o(n);fetch(n.href,s)}})();class c extends Error{}c.prototype.name="InvalidTokenError";function b(e){return decodeURIComponent(atob(e).replace(/(.)/g,(t,o)=>{let r=o.charCodeAt(0).toString(16).toUpperCase();return r.length<2&&(r="0"+r),"%"+r}))}function v(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return b(t)}catch{return atob(t)}}function I(e,t){if(typeof e!="string")throw new c("Invalid token specified: must be a string");t||(t={});const o=t.header===!0?0:1,r=e.split(".")[o];if(typeof r!="string")throw new c(`Invalid token specified: missing part #${o+1}`);let n;try{n=v(r)}catch(s){throw new c(`Invalid token specified: invalid base64 for part #${o+1} (${s.message})`)}try{return JSON.parse(n)}catch(s){throw new c(`Invalid token specified: invalid json for part #${o+1} (${s.message})`)}}const m=document.getElementById("login-view"),p=document.getElementById("summary-view"),y=document.getElementById("app-footer"),E=document.getElementById("login-form"),g=document.getElementById("login-btn"),f=document.getElementById("login-error"),a=document.getElementById("summarize-btn"),u=document.getElementById("page-info"),h=document.getElementById("status-message"),k=document.getElementById("username-display"),B=document.getElementById("logout-btn"),L="http://localhost:8000";let w=null;function l(e,t=!0){const o=e.querySelector(".spinner"),r=e.querySelector(".btn-text");t?(o.style.display="block",r&&(r.style.display="none"),e.disabled=!0):(o.style.display="none",r&&(r.style.display="block"),e.disabled=!1)}function i(e,t="info"){h.textContent=e,h.className=t}async function S(){const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e.url||!e.url.startsWith("http")){u.innerHTML="<p>Cannot summarize this page.</p>",a.disabled=!0;return}const[t]=await chrome.scripting.executeScript({target:{tabId:e.id},function:()=>{const r=!!document.querySelector('article, [role="article"]');return document.querySelector("video")?"video":r||document.body.innerText.length>2e3?"article":null}}),o=t.result;o?(u.innerHTML=`<p>Found a potential <b>${o}</b> to summarize.</p>`,a.disabled=!1,w={tab:e,contentType:o}):(u.innerHTML="<p>No article or video found on this page.</p>",a.disabled=!0)}document.addEventListener("DOMContentLoaded",async()=>{const{token:e}=await chrome.storage.local.get("token");if(e)try{const o=I(e).sub;k.textContent=o,m.style.display="none",p.style.display="block",y.style.display="flex",await S()}catch(t){console.error("Invalid token found:",t),await chrome.storage.local.remove("token"),m.style.display="block",p.style.display="none",y.style.display="none"}});E.addEventListener("submit",async e=>{e.preventDefault(),l(g),f.textContent="";const t=document.getElementById("username").value,o=document.getElementById("password").value,r=new URLSearchParams({username:t,password:o});try{const n=await fetch(`${L}/token`,{method:"POST",body:r});if(!n.ok)throw new Error("Invalid username or password.");const s=await n.json();await chrome.storage.local.set({token:s.access_token}),window.location.reload()}catch(n){f.textContent=n.message,l(g,!1)}});B.addEventListener("click",async()=>{await chrome.storage.local.remove("token"),window.location.reload()});a.addEventListener("click",async()=>{l(a),i("Waking background…");try{await chrome.runtime.sendMessage({type:"ping"}),console.log("[popup] ping success")}catch{console.warn("[popup] ping error:",chrome.runtime.lastError)}i("Initializing model…"),chrome.runtime.sendMessage({type:"summarize",payload:w},e=>{console.log("[popup] summarize response:",e),chrome.runtime.lastError?i("Background unavailable. Try again.","error"):e?.success?i("Saved successfully!","success"):i(e?.error||"Unknown error","error"),l(a,!1),a.disabled=!0})});chrome.runtime.onMessage.addListener(e=>{e.type==="progress"&&i(e.data)});
